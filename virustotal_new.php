<?php

require_once('VirusTotalApiV2.php');

/* Initialize the VirusTotalApi class. */
$api = new VirusTotalAPIV2('YOUR_API');

/// MySQL DB name 
$db_name = "peanalysis";
///MySQL DB user 
$db_user = "peanalysis";
///MySQL DB password
$db_password = "peanalys";
///MySQL server address
$db_host = "localhost";

//Make MySQL Conntection
if (mysql_connect($db_host, $db_user, $db_password) === FALSE)
    $this->output.="Cannot Create Connection to DB<br>";
if (mysql_select_db($db_name) === FALSE)
    $this->output.="Cannot Select the Table into DB<br>";

//Count number of unprocessed items
$query = "SELECT COUNT(`id`) FROM `rawData` WHERE `virustotal_file_report`='i:-1;' ; ";
if (($res = mysql_query($query)) === FALSE)
    echo "\n Impossible to execute SELECT query! ";
$number = mysql_fetch_array($res);
$number = $number[0];


$i = 0;
$limit=100;
//Go thoruhg all the files
while ($i < $number) {
	//Read all unprocessed items and retreive reports
    $query = "SELECT HEX(`md5`) FROM `rawData` WHERE `virustotal_file_report`='i:-1;'  LIMIT " . $i . ",".$limit." ;";
    if (($res = mysql_query($query)) === FALSE)
        echo "\n Impossible to execute SELECT query! ";

    //form query
    $query = "INSERT INTO `rawData`
        (`md5`,`virustotal_file_report`)
        VALUES ";
    $query_insert = "";
    //go through all the files
    $count=0;
    while (($row = mysql_fetch_array($res))&&($count<$limit)) 
    {
		echo $row[0]."\n";
        // Get a file report for each of the md5 sums.
        $report = $api->getFileReport($row[0]);
		print_r($report);
        $virustotal_file_report = mysql_real_escape_string(serialize($api->returnResult($report)));
        $query_insert.=" (UNHEX('" . $row[0] . "'), '" . $virustotal_file_report . "'),";
		//Check whether it is possible to execute query
		$i++; 
		$count++;       
    }

    $query_insert = rtrim($query_insert, ',');
    $query.=$query_insert . " ON DUPLICATE KEY  UPDATE `virustotal_file_report`= VALUES(`virustotal_file_report`);"; 
    if (mysql_query($query) === FALSE)
        echo "\n Impossible to execute INSERT/UPDATE query! ";
    echo $i."\n";
    if($i==75000)
    break;
}
?>
