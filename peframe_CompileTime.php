<?php


/// MySQL DB name
$db_name = "peanalysis";
///MySQL DB user
$db_user = "peanalysis";
///MySQL DB password
$db_password = "peanalys";
///MySQL server address
$db_host = "localhost";

//Make MySQL Conntection
if (mysql_connect($db_host, $db_user, $db_password) === FALSE)
    $this->output.="Cannot Create Connection to DB<br>";
if (mysql_select_db($db_name) === FALSE)
    $this->output.="Cannot Select the Table into DB<br>";


$i = 0;
$query = "SELECT HEX(`md5`),`peframe` AS `peframe` FROM `rawData` WHERE  `do_not_process` is NULL LIMIT 100000 OFFSET 400000 ;";
if (($res = mysql_query($query)) === FALSE)
    echo "\n Impossible to execute SELECT query! ";

while ($row = mysql_fetch_array($res)) {
    //name of the file (md5 sum)
    $file = strtolower($row[0]);
    $md5 = $file;
    if($row['peframe']!='') {
    $json=unserialize($row['peframe']);
        $json=json_decode($json);


if(isset($json[0]->{'Short Info'}->{'Compile Time'})) {
    $CompileTime=$json[0]->{'Short Info'}->{'Compile Time'};
    $malware=$row['malware'];

    $query = "INSERT INTO `pe_header_compile_time`
        (`md5`,
    `CompileTime`,
    `malware`)
        VALUES (
    UNHEX('" . $md5 . "'),
        '" .$CompileTime . "',
        '1')
       ON DUPLICATE KEY
       UPDATE
        `CompileTime`='" .$CompileTime . "',
        `malware`='1';";
    //Check whether it is possible to execute query
    if (mysql_query($query) === FALSE)
        echo "\n Impossible to execute INSERT/UPDATE query! File: " . $md5;
    }
    $i++;
    if ($i % 100 == 0)
    echo $i . "\n";
    }

}
