<?php

require_once('VirusTotalApiV2.php');

/* Initialize the VirusTotalApi class. */
$api = new VirusTotalAPIV2('YUOR_API');

/// MySQL DB name 
$db_name = "peanalysis";
///MySQL DB user 
$db_user = "peanalysis";
///MySQL DB password
$db_password = "peanalys";
///MySQL server address
$db_host = "localhost";

//Make MySQL Conntection
if (mysql_connect($db_host, $db_user, $db_password) === FALSE)
    $this->output.="Cannot Create Connection to DB<br>";
if (mysql_select_db($db_name) === FALSE)
    $this->output.="Cannot Select the Table into DB<br>";

$dir = 'windows/PE/';

//Count number of unprocessed items
$query = "SELECT COUNT(`id`) FROM `rawData` WHERE `virustotal_file_report`='i:-1;' ; ";
if (($res = mysql_query($query)) === FALSE)
    echo "\n Impossible to execute SELECT query! ";
$number = mysql_fetch_array($res);
$number = $number[0];
echo $number;

$i = 0;
//Read all unprocessed items and retreive reports that has empty virustotal report
$query = "SELECT HEX(`md5`) FROM `rawData` WHERE `virustotal_file_report` ='i:-1;'; ";
if (($res = mysql_query($query)) === FALSE)
	echo "\n Impossible to execute SELECT query! ";

clearstatcache();
while ($row = mysql_fetch_array($res)) 
{

	$fileName= strtolower($row[0]);
    //Get a file report for each of the md5 sums.
    echo $fileName."\n";
	$result =$api->scanFile($dir.$fileName);
	print_r($result);
	// Can be used to check for the report later on.
	$scanId = $api->getScanID($result); 
	$api->displayResult($result);
	$i++; 
}
echo $i."\n";
?>
