<?php

function entropy($string) {
    $h = 0;
    $size = strlen($string);
    foreach (count_chars($string, 1) as $v) {
        $p = $v / $size;
        $h -= $p * log($p) / log(2);
    }
    return $h;
}

///MySQL DB name 
$db_name = "peanalysis";
///MySQL DB user 
$db_user = "peanalysis";
///MySQL DB password
$db_password = "peanalys";
///MySQL server address
$db_host = "localhost";

//Make MySQL Conntection
if (mysql_connect($db_host, $db_user, $db_password) === FALSE)
    $this->output.="Cannot Create Connection to DB<br>";
if (mysql_select_db($db_name) === FALSE)
    $this->output.="Cannot Select the Table into DB<br>";

//Path to the storage with files (names as md5)
$dir = 'windows/PE/';
$i = 0;

$query = "SELECT HEX(`md5`) FROM `rawData` WHERE  `do_not_process` is NULL AND `peframe` is NULL ;";
if (($res = mysql_query($query)) === FALSE)
    echo "\n Impossible to execute SELECT query! ";

while ($row = mysql_fetch_array($res)) {
    //name of the file (md5 sum)
    $file = strtolower($row[0]);
    $md5 = $file;
    echo $md5."\n";

    //peframe dump
    $peframe = shell_exec("timeout 120 peframe --json " . $dir . $file);
    //fix the PEframe formatting
    $peframe = "[" . str_replace("} {", "}, {", $peframe) . "]";
    $peframe = mysql_real_escape_string(serialize($peframe));
    //output of the file command
    $file_output = shell_exec(" file " . $dir . $file . "  | awk '{print substr($0, index($0, $2))}' ");
    $file_output = mysql_real_escape_string($file_output);
    //output of the strings command
    $strings_output = shell_exec("strings " . $dir . $file);
    $strings_output = mysql_real_escape_string($strings_output);
    //output of the size command
    $size_output = shell_exec("size " . $dir . $file . "    | awk '{if(NR>1)print $1, \" \", $2, \" \", $3, \" \", $4}' ");
    $size_output = mysql_real_escape_string($size_output);
    //entropy of the file
    $file_entropy = entropy(file_get_contents($dir . $file));
    //form query
    $query = "INSERT INTO `rawData`
        (`md5`,
        `peframe`,
        `file`,
        `strings`,
        `size`,
        `file_entropy`)
        VALUES (
        UNHEX('" . $md5 . "'),
        '" . $peframe . "',
        '" . $file_output . "',
        '" . $strings_output . "',
        '" . $size_output . "',
        '" . $file_entropy . "') 
       ON DUPLICATE KEY 
       UPDATE 
        `peframe`='" . $peframe . "',
        `file`='" . $file_output . "',
        `strings`='" . $strings_output . "',
        `size`='" . $size_output . "',
        `file_entropy`='" . $file_entropy . "';";

    //Check whether it is possible to execute query
    if (mysql_query($query) === FALSE)
        echo "\n Impossible to execute INSERT/UPDATE query! File: " . $md5;
    $i++;
    if ($i % 1 == 0)
        echo $i . "\n";
}
?>
